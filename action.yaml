name: "Hushify â€“ Fetch Secret"
description: "Retrieve a one-time secret from hushify.io using a token or URL"
author: "hushify.io"

branding:
  icon: lock
  color: purple

inputs:
  hushify:
    description: "Hushify secret token OR full URL"
    required: true

outputs:
  secret:
    description: "The retrieved secret value"

runs:
  using: "composite"
  steps:
    - shell: bash
      run: |
        set -euo pipefail

        INPUT="${{ inputs.hushify }}"

        if [[ "$INPUT" =~ ^https?:// ]]; then
          # Extract token from URL if full URL provided
          if [[ "$INPUT" =~ \?token=([A-Za-z0-9_-]+) ]]; then
            TOKEN="${BASH_REMATCH[1]}"
            HUSHIFY_URL="https://www.hushify.io/api/unwrap?token=$TOKEN"
          elif [[ "$INPUT" =~ /api/unwrap\?token=([A-Za-z0-9_-]+) ]]; then
            # Already using API endpoint
            HUSHIFY_URL="$INPUT"
          else
            # Try to extract token from any URL format
            TOKEN=$(echo "$INPUT" | grep -oE '[?&]token=([A-Za-z0-9_-]+)' | cut -d= -f2 || echo "")
            if [ -n "$TOKEN" ]; then
              HUSHIFY_URL="https://www.hushify.io/api/unwrap?token=$TOKEN"
            else
              echo "âŒ Could not extract token from URL: $INPUT"
              exit 1
            fi
          fi
        else
          if [[ ! "$INPUT" =~ ^[A-Za-z0-9_-]{20,}$ ]]; then
            echo "âŒ Invalid hushify token format"
            exit 1
          fi
          HUSHIFY_URL="https://www.hushify.io/api/unwrap?token=$INPUT"
        fi

        echo "ðŸ” Fetching secret from: $HUSHIFY_URL"
        HTTP_CODE=$(curl -sSLo /tmp/hushify_response \
          -w "%{http_code}" \
          -H "User-Agent: hushify-github-action/1.1" \
          "$HUSHIFY_URL" || echo "000")

        if [ -z "$HTTP_CODE" ] || [ "$HTTP_CODE" = "000" ] || [ "$HTTP_CODE" -ne 200 ]; then
          echo "âŒ Failed to retrieve secret"
          if [ -n "$HTTP_CODE" ] && [ "$HTTP_CODE" != "000" ]; then
            echo "HTTP status: $HTTP_CODE"
          else
            echo "Network error or invalid response"
          fi
          if [ -f /tmp/hushify_response ]; then
            RESPONSE=$(cat /tmp/hushify_response)
            if [ -n "$RESPONSE" ]; then
              echo "Response: $RESPONSE"
            fi
            rm -f /tmp/hushify_response
          fi
          exit 1
        fi

        SECRET=$(cat /tmp/hushify_response)
        rm -f /tmp/hushify_response

        if [ -z "$SECRET" ]; then
          echo "âŒ Secret is empty or already consumed"
          exit 1
        fi

        echo "âœ… Secret retrieved successfully"
        echo "::add-mask::$SECRET"
        echo "secret=$SECRET" >> "$GITHUB_OUTPUT"
